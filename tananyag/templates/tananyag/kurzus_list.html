{% extends 'base.html' %}
{% load static %}

{% block title %}El√©rhet≈ë Kurzusok{% endblock %}

{% block content %}
<div class="header">
    <h1>E-Learning Hallgat√≥i Fel√ºlet</h1>
    <div class="header-right">
        Szia, **{{ user.username }}**

        <a href="{% url 'hallgato_edit' %}" class="btn btn-sm btn-info">Profil Szerkeszt√©se</a>

        <a href="{% url 'logout' %}" class="btn btn-sm btn-secondary">Kijelentkez√©s</a>
    </div>
</div>

<hr>

<h2>El√©rhet≈ë Kurzusok</h2>

<div class="kurzus-container">
    {% for kurzus in kurzusok %}
    <div class="kurzus-kartya">
        <h3>{{ kurzus.nev }}</h3>
        <p>Oktat√≥: **{{ kurzus.tanar.nev }}**</p>
        <p>{{ kurzus.leiras|default:"Nincs le√≠r√°s." }}</p>

        {% if kurzus.id in felvett_kurzusok_id %}
            <button class="btn btn-success" disabled>Felvett kurzus</button>
        {% else %}
            <button
                class="btn btn-primary kurzus-felvetel-gomb"
                data-kurzus-id="{{ kurzus.id }}"
                onclick="kurzusFelvetel(this, {{ kurzus.id }})">
                Kurzus felv√©tele
            </button>
        {% endif %}

    </div>
    {% endfor %}
</div>

{% csrf_token %}

<script>
    // 1. CSRF Token kinyer√©se a rejtett mez≈ëb≈ël
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function kurzusFelvetel(buttonElement, kurzusId) {

        // 2. K√©relem el≈ëk√©sz√≠t√©se (JSON adat)
        const data = JSON.stringify({ 'kurzus_id': kurzusId });

        // Gomb letilt√°sa a v√°lasz meg√©rkez√©s√©ig
        buttonElement.disabled = true;
        buttonElement.textContent = 'Feldolgoz√°s...';

        // 3. FETCH API H√≠v√°s ind√≠t√°sa
        fetch('/api/kurzus-felvetel/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // üîë CSRF V√âDELEM
                'X-CSRFToken': csrftoken
            },
            body: data
        })
        .then(response => {
            // Ellen≈ërizz√ºk, hogy a v√°lasz st√°tuszk√≥dja sikeres-e (200-299)
            if (response.ok) {
                return response.json();
            }
            // Ha hiba van (pl. 400 Bad Request / M√°r felvette), dobjunk hib√°t
            return response.json().then(errorData => {
                throw new Error(errorData.hiba || errorData.error || 'Ismeretlen hiba t√∂rt√©nt');
            });
        })
        .then(data => {
            // 4. SIKERES V√ÅLASZ (views.py status=200)
            console.log('Sikeres felv√©tel:', data.siker || data.message);

            // Friss√≠t√©s: gomb √°llapot√°nak v√°ltoztat√°sa
            buttonElement.classList.remove('btn-primary');
            buttonElement.classList.add('btn-success');
            buttonElement.textContent = 'Felvett kurzus';
            // A gomb letilt√°sa v√©glegesen, mert m√°r felvette
            buttonElement.disabled = true;

        })
        .catch(error => {
            // 5. HIBA KEZEL√âSE (views.py status=400)
            console.error('Hiba:', error.message);
            alert('Kurzus felv√©tel hiba: ' + error.message);

            // Vissza√°ll√≠t√°s hib√°n√°l
            buttonElement.disabled = false;
            buttonElement.textContent = 'Kurzus felv√©tele';
        });
    }
</script>

<style>
/* Egyszer≈± st√≠lusok, a Bootstrap mellett */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
}
.kurzus-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}
.kurzus-kartya {
    border: 1px solid #ccc;
    padding: 15px;
    width: 300px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
}
</style>
{% endblock %}