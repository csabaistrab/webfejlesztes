{% extends 'base.html' %}
{% load static %}

{% block title %}Elérhető Kurzusok{% endblock %}

{% block content %}
<div class="header">
    <h1>E-Learning Hallgatói Felület</h1>
    <div class="header-right d-flex align-items-center">
        <span class="me-3">Szia, <b>{{ user.hallgato.nev }}</b></span>

        <a href="{% url 'hallgato_edit' %}" class="btn btn-info me-2">Profil Szerkesztése</a>

        <form method="post" action="{% url 'logout' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary">Kijelentkezés</button>
        </form>
    </div>
</div>

<hr>

<h2>Elérhető Kurzusok</h2>

<div class="kurzus-container">
    {% for kurzus in kurzusok %}
    <div class="card kurzus-kartya p-3">
        <h3><b>{{ kurzus.nev }}</b></h3>
        <p>Oktató: <b>{{ kurzus.tanar.nev }}</b></p>
        <p>{{ kurzus.leiras|default:"Nincs leírás." }}</p>

        {% if kurzus.id in felvett_kurzusok_id %}
            <button class="btn btn-success" disabled>Felvett kurzus</button>
        {% else %}
            <button
                class="btn btn-primary kurzus-felvetel-gomb"
                data-kurzus-id="{{ kurzus.id }}"
                onclick="kurzusFelvetel(this, {{ kurzus.id }})">
                Kurzus felvétele
            </button>
        {% endif %}

    </div>
    {% endfor %}
</div>

{% csrf_token %}

<script>
    // 1. CSRF Token kinyerése
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function kurzusFelvetel(buttonElement, kurzusId) {

        const data = JSON.stringify({ 'kurzus_id': kurzusId });

        buttonElement.disabled = true;
        buttonElement.textContent = 'Feldolgozás...';

        // 3. FETCH API Hívás indítása
        fetch('{% url "kurzus_felvetel" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: data
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.json().then(errorData => {
                // Hiba esetén is JSON-t vár a szervertől (a views.py miatt)
                throw new Error(errorData.hiba || errorData.error || 'Ismeretlen hiba történt');
            });
        })
        .then(data => {
            // SIKERES VÁLASZ
            console.log('Sikeres felvétel:', data.siker || data.message);

            buttonElement.classList.remove('btn-primary');
            buttonElement.classList.add('btn-success');
            buttonElement.textContent = 'Felvett kurzus';
            buttonElement.disabled = true;

        })
        .catch(error => {
            // HIBA KEZELÉSE
            console.error('Hiba:', error.message);
            alert('Kurzus felvétel hiba: ' + error.message);

            buttonElement.disabled = false;
            buttonElement.textContent = 'Kurzus felvétele';
        });
    }
</script>

<style>
/* Egyszerű stílusok a tiszta megjelenéshez */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
}
.kurzus-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}
.kurzus-kartya {
    border: 1px solid #ccc;
    width: 300px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
}
</style>
{% endblock %}