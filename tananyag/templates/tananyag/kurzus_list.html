{% load static %}
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Kurzusok Listája | E-Learning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .kurzus-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
            transition: transform 0.2s;
        }
        .kurzus-card:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    {% csrf_token %}

    <nav class="navbar navbar-expand-lg navbar-light bg-light p-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">E-Learning Hallgatói Felület</span>
            <span class="navbar-text">
                Szia, <strong>{{ user.username }}</strong>!

                <form method="post" action="{% url 'logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-secondary ms-3">
                        Kijelentkezés
                    </button>
                </form>

            </span>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>Elérhető Kurzusok</h1>

        <div class="row">
            {% for kurzus in kurzusok %}
            <div class="col-md-4">
                <div class="card kurzus-card">
                    <div class="card-body">
                        <h5 class="card-title text-primary">{{ kurzus.nev }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">Oktató: {{ kurzus.tanar.nev }}</h6>
                        <p class="card-text">{{ kurzus.leiras|truncatechars:100 }}</p>

                        {% if kurzus.id in felvett_kurzusok_id %}
                            <button
                                class="btn btn-secondary"
                                disabled
                            >
                                Felvett kurzus
                            </button>
                        {% else %}
                            <button
                                class="btn btn-success felvetel-btn"
                                data-kurzus-id="{{ kurzus.id }}"
                                onclick="felvesz({{ kurzus.id }}, this)"
                            >
                                Kurzus felvétele
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <p class="alert alert-warning">Jelenleg nincsenek elérhető kurzusok.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function felvesz(kurzusId, button) {

            // CSRF token beszerzése a Django sablonból
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // fetch API használata (aktuális technológia)
            fetch('{% url "kurzus_felvetel_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // Biztonsági header
                },
                body: JSON.stringify({
                    kurzus_id: kurzusId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hiba: ' + data.error);
                } else {
                    alert(data.message);
                    // Gomb állapotának frissítése sikeres felvétel után
                    button.innerText = 'Felvett kurzus';
                    button.disabled = true;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-secondary');
                }
            })
            .catch(error => {
                console.error('Hiba történt a felvétel közben:', error);
                alert('Váratlan hiba történt a szerveren.');
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>